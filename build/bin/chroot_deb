#!/usr/bin/bash

# Setzt Owner fuer ein Debian-Paket mit allen Elementen auf root:root.
# Muss mit root-Rechten ausgefuehrt werden.

STAGING_ROOT="/tmp/chroot_deb"
STAGING_DEB="$STAGING_ROOT/deb"
STAGING_CONTROL="$STAGING_ROOT/control"
STAGING_DATA="$STAGING_ROOT/data"
STAGING_WHEEL="$STAGING_ROOT/wheel"

DEB_VERSION_FILE=debian-binary
CONTROL_ARCHIVE=control.tar.xz
DATA_ARCHIVE=data.tar.xz

# Pruefen, ob wir root sind
if [ "$USER" != "root" ]; then
  echo "chroot_deb muss mit Root-Rechten aufgerufen werden"
  exit 1
fi

# Argumente einlesen
if [ "$1" = "" ]; then
  echo "Aufruf: chroot_deb <Debian-Installationspaket>"
  exit 1
fi
DEB_PACKAGE_FILE=`basename $1`
DEB_PACKAGE_PATH=`realpath $1`
dash_index=`expr index $DEB_PACKAGE_FILE "-"`
PROJECT_NAME=${DEB_PACKAGE_FILE:0:dash_index-1}

# Debian-Paket in Staging-Verzeichnis kopieren
rm -rf $STAGING_ROOT
mkdir $STAGING_ROOT $STAGING_DEB $STAGING_CONTROL $STAGING_DATA $STAGING_WHEEL
cp $DEB_PACKAGE_PATH $STAGING_DEB
cd $STAGING_DEB
ar xv $DEB_PACKAGE_FILE
rm -f $DEB_PACKAGE_FILE
mv $CONTROL_ARCHIVE $STAGING_CONTROL
mv $DATA_ARCHIVE $STAGING_DATA

# Steuerdateien aendern
cd $STAGING_CONTROL
tar xpvf $CONTROL_ARCHIVE
rm -f $CONTROL_ARCHIVE
chown root:root *
tar cJf $CONTROL_ARCHIVE *
mv $CONTROL_ARCHIVE $STAGING_DEB

# Data-Dateien entpacken
cd $STAGING_DATA
tar xpvf $DATA_ARCHIVE
rm -f $DATA_ARCHIVE

# Wheel-Dateien aendern
cd $STAGING_DATA/opt/$PROJECT_NAME
WHEEL_FILE=`ls $PROJECT*.whl`
echo $WHEEL_FILE
cd $STAGING_DATA
mv $STAGING_DATA/opt/$PROJECT_NAME/$WHEEL_FILE $STAGING_WHEEL
cd $STAGING_WHEEL
unzip $WHEEL_FILE
rm -f $WHEEL_FILE
chown root:root *
zip -r $WHEEL_FILE *
mv $WHEEL_FILE $STAGING_DATA/opt/$PROJECT_NAME

# Daten-Dateien aendern
cd $STAGING_DATA
chown -R root:root *
tar cJf $DATA_ARCHIVE *
mv $DATA_ARCHIVE $STAGING_DEB

# Installationspaket wieder zusammenbauen
cd $STAGING_DEB
ar cr $DEB_PACKAGE_FILE $DEB_VERSION_FILE $CONTROL_ARCHIVE $DATA_ARCHIVE
cp $DEB_PACKAGE_FILE $DEB_PACKAGE_PATH
chown root:root $DEB_PACKAGE_PATH

