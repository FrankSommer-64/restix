#!/usr/bin/bash

# Erstellt Python wheel für ein Projekt
# Projekt Root-Verzeichnis muss unter $HOME/GITROOT/sw/projects liegen.
# Falls das Projekt wegen unterschiedlicher Features mehrere Installationspakete
# benötigt, muss das Script für jeden Feature-Umfang aufgerufen werden.

PROJECTS_ROOT="$HOME/GITROOT/sw/projects"
VENV_ACT="$HOME/.python_venv/build/bin/activate"
CONFIG_FILE_NAME="pyproject.toml"

# Argumente einlesen
if [ "$1" = "" ]; then
  echo "Kein Projekt angegeben"
  echo "Aufruf: py_build <Projekt> [<Feature-Umfang>]"
  exit 1
fi
PROJECT=$1
FEATURE_SET=""
if [ "$2" != "" ]; then
  FEATURE_SET=$2
fi

# pruefen, ob noetige Dateien existieren
REMOVE_CONFIG_FILE=false
PROJECT_ROOT="$PROJECTS_ROOT/$1"
BUILD_ROOT="$PROJECT_ROOT/build"
CONFIG_FILE="$PROJECT_ROOT/$CONFIG_FILE_NAME"
if [ ! -d $PROJECT_ROOT ]; then
  echo "Projekt-Verzeichnis $PROJECT_ROOT nicht gefunden"
  exit 1
fi
if [ "$FEATURE_SET" != "" ]; then
  CONFIG_DIR="$BUILD_ROOT/featuresets/$FEATURE_SET/wheel"
  if [ ! -d "$CONFIG_DIR" ]; then
    echo "Konfigurations-Verzeichnis $CONFIG_DIR nicht gefunden"
    exit 1
  fi
  FEATURE_SET_CONFIG_FILE="$CONFIG_DIR/$CONFIG_FILE_NAME"
  if [ ! -f "$FEATURE_SET_CONFIG_FILE" ]; then
    echo "Konfigurationsdatei $FEATURE_SET_CONFIG_FILE nicht gefunden"
    exit 1
  fi
  cp $FEATURE_SET_CONFIG_FILE $PROJECT_ROOT
  REMOVE_CONFIG_FILE=true
fi
if [ ! -f "$CONFIG_FILE" ]; then
  echo "Konfigurationsdatei $CONFIG_FILE nicht gefunden"
  exit 1
fi

# Build starten
source $VENV_ACT
cd $PROJECT_ROOT
echo "Build $PROJECT $FEATURE_SET"
hatchling build
deactivate
if [[ $REMOVE_CONFIG_FILE == true ]]; then
  rm $CONFIG_FILE
fi
